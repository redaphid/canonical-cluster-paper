<!DOCTYPE html>
<html>

<head>
  <link href="font-awesome/css/all.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="styles/main.css" type="text/css" rel="stylesheet">
  <script type="module">
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js'
    import { h, render } from 'https://esm.sh/preact'
    import htm from 'https://esm.sh/htm'
    const res = await fetch('message.json').then(res => res.json())
    const getMiroLink = (widget) => {
      return `${res.doc.miro}/?moveToWidget=${widget}`
    }

    const Doc = ({ doc }) => {
      console.log("from Doc", doc)
      const resume = {}
      return html`
          <div class="Doc">
            <${Heading} title=${doc.title} miro=${doc.miro} />
            <div class="Info">
            </div>
            <div class="Logo">
              <img src="${doc.logo}" alt="logo" />
            </>
            <div class="Main">
              ${doc.main.map(section => html`
                <${Prompts} section=${section} />
              `)}
              </div>
          </div>
          `
    }

    const Heading = ({ title, miro }) => {
      return html`
        <section class="Identity">
          <h1>${title}.</h1>
          <small>Want to see the diagrams in a Miro board? you can find them <a href="${miro}" target="_blank">here!</a></small>
        </section>
      `
    }
    const Prompts = ({ section }) => {
      console.log('from Prompts', section)
      return html`
        <section class="Prompts">
          <h3>${section.title}</h3>
          <ul>
            ${section.prompts.map(s => html`
              <li>
                <${Prompt} question=${s} />
              </li>
            `)}
          </ul>
        </section>
      `
    }
    const RenderRawHtml = ({ html }) => h('div', { dangerouslySetInnerHTML: { __html: html } })

    let figureFlip = 0
    const Prompt = ({ question }) => {
      const { prompt, answers } = question
      console.log('from Prompt', { figureFlip })
      return html`
      <div class="Prompt">
          <header>
            <h4>${prompt}</h4>
          </header>
          ${answers?.map(answer => {
            if(answer.figure) figureFlip++
            return html`
                <ul class="Answers">
                  <li class="Answer ${!(figureFlip % 2) ? 'flip-figure' : ''}">
                    <p><${RenderRawHtml} html=${marked(answer.response)}/></p>
                    ${answer.figure ? html`<${Figure} figure=${answer.figure} />` : ''}
                  </li>
                </ul>
              `})}

        </div>
      `
    }

    const Figure = ({ figure }) => {
      return html`
       ${figure.miro ? html`
        <a href=${getMiroLink(figure.miro)} target="_blank">
          <img src=figures/${figure.figure}.jpg />
        </a>` : html`<img src=${figure.figure} />`}
      `
    }
    const WithFigure = ({ prompt, answer }) => {
      console.log('from WithFigure', answer)
      return html`
        <div class="WithFigure">

          <p>${new Array(100).fill(answer.response).join('')}</p>
        </div>
      `
    }

    const html = htm.bind(h)
    render(html`<${Doc} doc=${res.doc}/>`, document.body)

    // helper functions
    const getUniqueAbilities = (resume) => {
      const abilities = resume.work.reduce((acc, work) => {
        const skills = work.skills.map(skill => { return { name: skill } })
        return [...acc, ...skills]
      }, [])

      const uniqueAbilities = [...new Set(abilities.map(item => item.name))].map(name => {
        return abilities.find(item => item.name === name)
      }).sort((a, b) => a.name.localeCompare(b.name))
      return uniqueAbilities
    }

    window.getUniqueAbilities = () => getUniqueAbilities(res)
  </script>

</head>

<body></body>

</html>
