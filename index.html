<!DOCTYPE html>
<html>
<head>
  <link href="font-awesome/css/all.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="styles/main.css"type="text/css" rel="stylesheet">
  <script type="module">
    import {marked} from  'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js'
    import { h, render } from 'https://esm.sh/preact'
    import htm from 'https://esm.sh/htm'
    const res = await fetch('message.json').then(res => res.json())
    console.log('from top', {res})
    const Doc = ({ doc }) => {
      console.log("from Doc", doc)
      const resume = {}
      return html`
          <div class="Doc">
            <${Identity} title=${doc.title} />
            <div class="Info">
            </div>
            <div class="Logo">
              <img src="${doc.logo}" alt="logo" />
            </>
            <div class="Main">
              ${doc.main.map(section => html`
                <${Prompts} section=${section} />
              `)}
              </div>
          </div>
          `
    }

    const Identity = ({ title }) => {
      return html`
        <section class="Identity">
          <h1>${title}.</h1>
        </section>
      `
    }

    const Communications = ({ profiles, identity }) => {
      const email = {
        network: 'envelope',
        url: `mailto:${identity.email}`,
        display: identity.email,
        isBrand: false,
      };
      const phone = {
        network: 'phone',
        url: `tel:${identity.phone}`,
        display: identity.phone,
        isBrand: false,
      };
      const location = {
        network: 'map-marker-alt',
        url: `https://www.google.com/maps/place/${identity.location.address}`,
        display: `${identity.location.city}, ${identity.location.region}`,
        isBrand: false,
      };
      // merge profiles with contact info
      const comms = [email, phone, ...profiles, location,];
      return html`
        <section class="Communications">
          <h3>Communications</h3>
          <ul>
            ${comms.map(profile => html`
              <li>
                <${Communication} profile=${profile} />
              </li>
            `)}
          </ul>
        </section>
      `
    }

    const Communication = ({ profile }) => {
      const url = profile.url || ''
      const isBrand = profile.isBrand ?? true;
      const display = profile.display || url.replace("https://", "")
      return html`
        <div class="Communication">
          <i class="fa-solid ${isBrand === true ? "fa-brands" : ""} fa-${profile.network}"></i>
          <a href="${profile.url}" target="_blank">
            ${display}
          </a>
        </div>
      `
    }
    const Prompts = ({ section }) => {
      console.log('from Prompts', section)
      return html`
        <section class="Prompts">
          <h3>${section.title}</h3>
          <ul>
            ${section.prompts.map(s => html`
              <li>
                <${Prompt} question=${s} />
              </li>
            `)}
          </ul>
        </section>
      `
    }
    const RenderRawHtml = ({ html }) => h('div', { dangerouslySetInnerHTML: { __html: html } })

    const Prompt = ({ question }) => {
      console.log('from Prompt', question)
      const {prompt, answers} = question
      return html`
      <div class="Prompt">
          <header>
            <h4>${prompt}</h4>
          </header>
          ${answers?.map(answer => html`
            <ul class="Answers">
              <li>
                ${
                  !answer?.type || answer?.type == "markdown"
                    ? html`<${RenderRawHtml} html=${marked(answer?.response)}/>`
                    : html`<${Answers[answer.type]} prompt=${prompt} answer=${answer} />`
                }
              </li>
            </ul>
          `)}

        </div>
      `
    }

    const WithFigure = ({ prompt, answer }) => {
      console.log('from WithFigure', answer)
      return html`
        <div class="WithFigure">
          <p>${new Array(100).fill(answer.response).join('')}</p>
          <figure>
           <img src="${answer.figure}" />
           <figcaption>Image caption</figcaption>
          </figure>
        </div>
      `
    }

    const TimeRange = ({ start, end }) => {
      return html`
        <time>
          ${start} to ${end ?? 'present'}
        </time>
      `
    }
    const Answers = {
      "WithFigure": WithFigure,
    }
/*
 <div class="Prompt">
          <header>
            <h4>${work.company}</h4>
            <${TimeRange} start=${work.startDate} end=${work.endDate} />
          </header>
          <em>${work.position}</em>
          <p class="Summary">${work.summary}</p>
          <${PromptSkills} skills=${work.skills} />
        </div>*/
    const PromptSkills = ({ skills }) => {
      return html`
        <ul class="PromptSkills">
          ${skills.map(skill => html`
            <li>
              ${skill}
            </li>
          `)}
        </ul>
      `
    }

    const Educations = ({ education }) => {
      return html`
        <section class="Educations">
          <h3>Education</h3>
          <ul>
            ${education.map(edu => html`
              <li>
                <${Education} education=${edu} />
              </li>
            `)}
          </ul>
        </section>
      `
    }

    const Education = ({ education }) => {
      return html`
        <div class="Education">
          <h4>${education.institution}</h4>
          <p>${education.area} </p>
          <p>${education.studyType}</p>
          <${TimeRange} start=${education.startDate} end=${education.endDate} />
        </div>
      `
    }

    const Admirers = ({ admirers }) => {
      return html`
        <section class="Educations">
          <h3>Admirers</h3>
          <ul>
            ${admirers.map(admirer => html`
              <li>
                <${Admirer} admirer=${admirer} />
              </li>
            `)}
          </ul>
        </section>
      `
    }

    const Admirer = ({ admirer }) => {
      return html`
        <div class="Admirer">
          <h4>${admirer.name}</h4>
          <a href="mailto:${admirer.email}?subject=What do you admire most about Aaron Herres?" target="_blank">${admirer.email}</a>
        </div>
      `
    }

    const Abilities = ({ skills }) => {
      return html`
        <section class="Abilities">
          <h3>Abilities</h3>
          <ul>
            ${skills.map(skill => html`
              <li>
                <${Ability} skill=${skill} />
              </li>
            `)}
          </ul>
        </section>
      `
    }

    const Ability = ({ skill }) => {
      return html`
        <div class="Ability">
          ${skill.name}
        </div>
      `
    }

    const html = htm.bind(h)
    render(html`<${Doc} doc=${res.doc}/>`, document.body)

    // helper functions
    const getUniqueAbilities = (resume) => {
      const abilities = resume.work.reduce((acc, work) => {
        const skills = work.skills.map(skill => { return { name: skill } })
        return [...acc, ...skills]
      }, [])

      const uniqueAbilities = [...new Set(abilities.map(item => item.name))].map(name => {
        return abilities.find(item => item.name === name)
      }).sort((a, b) => a.name.localeCompare(b.name))
      return uniqueAbilities
    }

    window.getUniqueAbilities = () => getUniqueAbilities(res)
  </script>

</head>

<body></body>

</html>
