<!DOCTYPE html>
<html>

<head>
  <link href="font-awesome/css/all.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="styles/main.css" type="text/css" rel="stylesheet">
  <script type="module">
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js'
    import { h, render } from 'https://esm.sh/preact'
    import htm from 'https://esm.sh/htm'
    const res = await fetch('message.json').then(res => res.json())

    const getMiroLink = widget => `${res.doc.miro}/?moveToWidget=${widget}`
    const getWidgetFromMiroLink = link => link.split('moveToWidget=')[1].split('&')[0]
    window.getWidgetFromMiroLink = getWidgetFromMiroLink

    const defer = () => new Promise(resolve => requestAnimationFrame(resolve))

    const titleToId = title => title.toLowerCase().replace(/ /g, '-')
    const getEditQueryParam = () => window.location.search.split('edit=')[1]

    if (getEditQueryParam()) {
      localStorage.setItem('editMode', getEditQueryParam())
    }
    const editMode = localStorage.getItem('editMode') === 'true'
    const getListOfPromptNamesWithoutAnswers = () => {
      return res.doc.main.reduce((acc, section) => {
        return acc.concat(section.prompts.reduce((acc, prompt) => {
          return acc.concat(prompt?.answers?.length ? [] : [prompt.prompt])
        }, []))
      }, [])
    }
    const promptsWithoutAnswers = () => {
      return res.doc.main.reduce((acc, section) => {
        return acc + section.prompts.reduce((acc, prompt) => {
          return acc + (prompt?.answers?.length && !prompt.inProgress? 0 : 1)
        }, 0)
      }, 0)
    }

    const promptsWithAnswers = () => {
      return res.doc.main.reduce((acc, section) => {
        return acc + section.prompts.reduce((acc, prompt) => {
          return acc + (prompt?.answers?.length ? 1 : 0)
        }, 0)
      }, 0)
    }

    const getPrompt = id => {
      const prompt = res.doc.main.reduce((acc, section) => {
        return acc + section.prompts.reduce((acc, prompt) => {
          return acc + (prompt?.answers?.length ? 1 : 0)
        }, 0)
      }, 0)
    }

    const progress = {
      total: promptsWithoutAnswers() + promptsWithAnswers(),
      withAnswers: promptsWithAnswers(),
      withoutAnswers: promptsWithoutAnswers(),
      remainingPromptsWithoutAnswers: getListOfPromptNamesWithoutAnswers(),
      timestamp: Date.now()
    }
    // get previous progress
    let previousProgress = JSON.parse(localStorage.getItem('progress'))
    // if there is no previous progress, set it
    if (!previousProgress) {
      localStorage.setItem('progress', JSON.stringify(progress))
      previousProgress = progress
    }
    // find out how long it's been since the previous progress
    const timeSinceLastUpdate = progress.timestamp - previousProgress.timestamp
    // see if we have more prompts answered
    if (previousProgress?.withAnswers < progress.withAnswers) {
      localStorage.setItem('progress', JSON.stringify(progress))
    }

    const RenderRawHtml = ({ html }) => h('div', { dangerouslySetInnerHTML: { __html: html } })
    const Progress = ({progress, timeSinceLastProgress}) => {
      const { total, withAnswers, withoutAnswers } = progress
      return html`
        <div class="Progress">
          <h3>Progress</h3>
          <h4>Since last update: ${timeSinceLastProgress}</h4>
          <p>${withAnswers} / ${total} (${Math.round((withAnswers / total) * 100)}%)</p>
          <p>${withoutAnswers} / ${total} (${Math.round((withoutAnswers / total) * 100)}%)</p>
        </div>    `
    }
    const Doc = ({ doc }) => {
      return html`
          <div class="Doc">
            <${Heading} title=${doc.title} miro=${doc.miro} repo=${doc.repo} />
            <div class="Info"/>
            <div class="Logo">
              <img src="${doc.logo}" alt="logo" />
            </>
            <div class="Intro">
              <${RenderRawHtml} html=${marked(doc.intro)} />
            </div>
            <div class="Main">
              ${doc.main.map(section => html`
                <${Prompts} section=${section} />
              `)}
              </div>
          </div>
          `
    }
    const Root = ({data}) => {
      return html`
        <div class="Root">
          <${Doc} doc=${data.doc} />
          ${editMode ? html`<${Edit} data=${data} />` : ''}
        </div>
      `
    }
    const Edit = ({ data }) => {
      const { doc } = data
      const timeSinceLastProgress = Math.round((Date.now() - previousProgress.timestamp) / 1000)
      // make time since last progress human readable
      const timeSinceLastProgressHumanReadable = new Date(timeSinceLastProgress * 1000).toISOString().substr(11, 8)
      return html`
        <div class="Edit">
          <${Progress} progress=${progress} timeSinceLastProgress=${timeSinceLastProgressHumanReadable} />
          <${RemainingPrompts} remainingPrompts=${progress.remainingPromptsWithoutAnswers} />
        </div>
      `
    }
    const RemainingPrompts = ({ remainingPrompts }) => {
      return html`
        <div class="RemainingPrompts">
          <h3>Remaining Prompts</h3>
          <ul>
            ${remainingPrompts.map(prompt => html`
              <li>
                <a href="#${titleToId(prompt)}">${prompt}
                  ${prompt}
                </a>
                </li>
            `)}
          </ul>
        </div>
      `
    }
    const Completion = ({ total, withAnswers, withoutAnswers }) => {
      return html`
        <div class="Completion">
          <h3>Completion</h3>
          <p>${withAnswers} / ${total} (${Math.round((withAnswers / total) * 100)}%)</p>
          <p>${withoutAnswers} / ${total} (${Math.round((withoutAnswers / total) * 100)}%)</p>
        </div>
      `
    }
    const Heading = ({ title, miro, repo }) => {
      return html`
        <section class="Identity">
          <h1>${title}.</h1>
          <small>Want to see the diagrams in a Miro board? you can find them <a href="${miro}" target="_blank">here!</a></small>
          <small>Want to see the crazy system I made specifically for this written interview? You can find it <a href="${repo}" target="_blank">here!</a></small>
        </section>
      `
    }
    const Prompts = ({ section }) => {
      return html`
        <section class="Prompts">
          <h3>${section.title}</h3>
          <ul>
            ${section.prompts.map(s => html`
              <li>
                <${Prompt} question=${s} />
              </li>
            `)}
          </ul>
        </section>
      `
    }

    let figureFlip = 0
    const Prompt = ({ question }) => {
      const { prompt, answers } = question

      return html`
      <div class="Prompt" id=${titleToId(prompt)}>
          <header>
            <h4>${prompt}</h4>
          </header>
          ${answers?.map(answer => {
            if(answer.figure) figureFlip++
            return html`
                <ul class="Answers">
                  <li class="Answer ${!(figureFlip % 2) ? 'flip-figure' : ''}">
                    ${answer.response? html`<p><${RenderRawHtml} html=${marked(answer.response)}/></p>`: ''}
                    ${answer.figure ? html`<${Figure} figure=${answer.figure} hasResponse=${!!answer.response} />` : ''}
                  </li>
                </ul>
              `})}

        </div>
      `
    }

    const Figure = ({ figure, hasResponse }) => {
      return html`
       ${figure.miro ? html`
        <a id="figure-${figure.figure}" href=${getMiroLink(figure.miro)} target="_blank">
          <img class="${!hasResponse? "fill-response": ""}"  src="figures/${figure.figure}".jpg />
        </a>` : html`<img  class="${!hasResponse? "fill-response": ""}" src="figures/${figure.figure}.jpg" />`}
      `
    }
    const html = htm.bind(h)
    render(html`<${Root} data=${res}/>`, document.body)
  </script>

</head>

<body></body>

</html>
